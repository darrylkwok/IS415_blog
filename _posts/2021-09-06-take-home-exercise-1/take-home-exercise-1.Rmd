---
title: "Take-Home Exercise 1"
description: |
  A short description of the post.
author:
  - name: Darryl Kwok
    url: https://example.com/darrylkwok
date: 09-06-2021
output:
  distill::distill_article:
    self_contained: false
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Install and load neccessary Packages
```{r}
packages = c('sf', 'tmap', 'tidyverse', 'readxl')
for (p in packages){
  if(!require(p, character.only = T)){
    install.packages(p)
  }
  library(p,character.only = T)
}
```

## Data 
### Read in Geospatial Data
``` {r echo=TRUE}
jakarta_geo = st_read(dsn="data/geospatial", layer="BATAS_DESA_DESEMBER_2019_DUKCAPIL_DKI_JAKARTA")
```
### Transforming Projection of DKI Jakarta to DGN95
```{r echo=TRUE}
jakarta_geo <- st_transform(jakarta_geo, crs=23837)

st_geometry(jakarta_geo)
```

### Select the first 9 columns of the Geospatial Data
```{r echo=TRUE}
jakarta_geo <- jakarta_geo[0:9]

jakarta_geo
```
```{r echo=TRUE}
jakarta_geo <- jakarta_geo[0:9]

jakarta_geo
```

### Visualize the islands that are in the Geospatial File
```{r echo=TRUE}
tmap_mode("view")
tm_shape(jakarta_geo) + 
  tm_polygons()
```

###Remove the outer islands
```{r echo=TRUE}
tmap_mode("plot")
jakarta_geo <- jakarta_geo %>%
  filter(grepl("JAKARTA", KAB_KOTA, fixed=TRUE))

tm_shape(jakarta_geo) + 
  tm_polygons()

tmap_mode("view")
```


### Read in Aspatial Data
### Create a function to preprocess each excel file

This function will read in the excel file, removes the duplicated columns and select the 8 columns that are required which includes a new month column that was created

```{r echo=TRUE, eval=FALSE}
aspatial_function <- function (xlsx_filepath) {
  xlsx_file <- read_excel(xlsx_filepath, .name_repair="minimal") 
  
  xlsx_file <- xlsx_file[-c(1), !duplicated(colnames(xlsx_file), fromLast=TRUE)] %>% 
    mutate(`month` = substr(xlsx_filepath, gregexpr(pattern="Corona", xlsx_filepath)[[1]] + 11, gregexpr(pattern="Pukul", xlsx_filepath)[[1]] - 2)) %>%
    select(`ID_KEL`, `Nama_provinsi`,
           `nama_kota`, `nama_kecamatan`,
           `nama_kelurahan`, `POSITIF`, `Meninggal`, `month`)
  
  return(xlsx_file)
}
```

### Read in all the excel files and process them through the created function
```{r echo=TRUE, eval=FALSE}
setwd('data/aspatial')
file.list <- list.files(pattern='*.xlsx')

jakarta_asp <- data.frame(Date=as.Date(character()),
                 File=character(), 
                 User=character(), 
                 stringsAsFactors=FALSE) 

for (each_file in file.list) {
  jakarta_asp <- rbind(jakarta_asp, aspatial_function(each_file))
}

jakarta_asp
```

###Replace "P." to "Pulau"
```{r echo=TRUE, eval=FALSE}
jakarta_asp$nama_kelurahan <- gsub("P\\.", "PULAU", jakarta_asp$nama_kelurahan)
```

### Save the Aspatial file as RDS
```{r echo=TRUE, eval=FALSE}
jakarta_asp_rds <- write_rds(jakarta_asp, "data/rds/jakarta_asp.rds")
```

### Read the RDS Aspatial File
```{r echo=TRUE}
jakarta_asp <- read_rds("data/rds/jakarta_asp.rds")

```

### Prepare data to have cummulative monthly covid data in each column
```{r echo=TRUE}
jakarta_asp <- jakarta_asp %>%
  group_by(ID_KEL, Nama_provinsi, nama_kota, nama_kecamatan, nama_kelurahan, month) %>%
  summarise(`MENINGGAL` = sum(`Meninggal`), `POSITIF` = sum(`POSITIF`)) %>%
  ungroup() %>%
  pivot_wider(names_from=month, values_from=c(POSITIF, MENINGGAL))
  
jakarta_asp
```

### Convert all NA values to 0
```{r echo=TRUE}
jakarta_asp[is.na(jakarta_asp)] <- 0
```

### Join the Geospatial and Aspatial Data
```{r echo=TRUE}
jakarta_full <- right_join(jakarta_asp, jakarta_geo, by= 
                            c("ID_KEL" = "KODE_DESA",         
                              "Nama_provinsi" = "PROVINSI",
                              "nama_kota" = "KAB_KOTA" ,
                              "nama_kecamatan" = "KECAMATAN",
                              "nama_kelurahan" = "DESA_KELUR"))

```

###Perform Calculation to Generate Total Deaths and Total Positive for each area
```{r echo=TRUE}
jakarta_full <- jakarta_full %>%
  mutate(`TOTAL POSITIF` = rowSums(.[6:22])) %>%
  mutate(`TOTAL MENINGGAL` = rowSums(.[23:39]))

jakarta_full[is.na(jakarta_full)] <- 0
```

### Perform calculation to Generate the Cumulative confirmed cases per 1000 and death rate
The cumulative confirmed cases per 1000 calculates the number of confirmed cases per 1000 people. The death rate calculates the ratio of deaths to the number of confirmed cases
```{r echo=TRUE}
jakarta_full_rates <- jakarta_full 

jakarta_full_rates[23:39] <- jakarta_full_rates[23:39] / (jakarta_full_rates[6:22]/1000)
jakarta_full_rates[6:22] <- jakarta_full_rates[6:22] / (jakarta_full_rates$JUMLAH_PEN / 1000)

jakarta_full_rates_a <- jakarta_full_rates %>%
  drop_na()
```

### Compute the COnfirmed Cases Rate and Death Rate for 5 months interval for each Area
```{r echo=TRUE}
first_quarter <- c("Maret 2020", "April 2020", "MEI 2020", "Juni 2020", "Juli 2020")
second_quarter <- c("Agustus 2020", "September 2020", "Oktober 2020", "November 2020", "Desember 2020")
third_quarter <- c("Januari 2021", "Februari 2021", "Maret 2021", "April 2021", "Mei 2021")
fourth_quarter <- c("Juni 2021", "Juli 2021")

all_quarters = list(first_quarter, second_quarter, third_quarter, fourth_quarter)

jakarta_full_rates_qtr <- jakarta_full_rates %>%
  mutate(`First Quarter Positif` = select(., "POSITIF_Maret 2020", "POSITIF_April 2020", "POSITIF_MEI 2020", "POSITIF_Juni 2020", "POSITIF_Juli 2020") %>% rowSums()) %>%
  mutate(`Second Quarter Positif` = select(.,"POSITIF_Agustus 2020", "POSITIF_September 2020", "POSITIF_Oktober 2020", "POSITIF_November 2020", "POSITIF_Desember 2020") %>% rowSums()) %>%
  mutate(`Third Quarter Positif` = select(., "POSITIF_Januari 2021", "POSITIF_Februari 2021", "POSITIF_Maret 2021", "POSITIF_April 2021", "POSITIF_Mei 2021") %>% rowSums()) %>% 
  mutate(`Fourth Quarter Positif` = select(., "POSITIF_Juni 2021", "POSITIF_Juli 2021") %>% rowSums()) %>%
  mutate(`First Quarter Meninggal` = select(., "MENINGGAL_Maret 2020", "MENINGGAL_April 2020", "MENINGGAL_MEI 2020", "MENINGGAL_Juni 2020", "MENINGGAL_Juli 2020") %>% rowSums()) %>% 
  mutate(`Second Quarter Meninggal` = select(.,"MENINGGAL_Agustus 2020", "MENINGGAL_September 2020", "MENINGGAL_Oktober 2020", "MENINGGAL_November 2020", "POSITIF_Desember 2020") %>% rowSums()) %>%
  mutate(`Third Quarter Meninggal` = select(., "MENINGGAL_Januari 2021", "MENINGGAL_Februari 2021", "MENINGGAL_Maret 2021", "MENINGGAL_April 2021", "MENINGGAL_Mei 2021") %>% rowSums()) %>% 
  mutate(`Fourth Quarter Meninggal` = select(., "MENINGGAL_Juni 2021", "MENINGGAL_Juli 2021") %>% rowSums()) %>%
  select(`ID_KEL`, `Nama_provinsi`, `nama_kota`, `nama_kecamatan`, `First Quarter Positif`, `Second Quarter Positif`, `Third Quarter Positif`, `Fourth Quarter Positif`, `First Quarter Meninggal`, `Second Quarter Meninggal`, `Third Quarter Meninggal`, `Fourth Quarter Meninggal`, `geometry`)

jakarta_full_rates_qtr[is.na(jakarta_full_rates_qtr)] <- 0
```

## Exploring the Geospatial Data
### Convert R dataframe into sf object
```{r echo=TRUE}
jakarta_full <- st_as_sf(jakarta_full)
jakarta_full_rates <- st_as_sf(jakarta_full_rates)
jakarta_full_rates_a <- st_as_sf(jakarta_full_rates_a)
jakarta_full_rates_qtr <- st_as_sf(jakarta_full_rates_qtr)
```

### Create function to plot simple maps
```{r echo=TRUE}
simple_map_plot <- function(df, varname) {
  tm_shape(jakarta_full_rates) +
    tm_polygons() +
  tm_shape(df) +
    tm_fill(varname) +
    tm_borders(lwd=0.1, alpha = 1)
}

```


### Plot the Population, Positive Cases and Deaths Map
```{r echo=TRUE}
pop_map <- simple_map_plot(jakarta_full, "JUMLAH_PEN")

positive_map <- simple_map_plot(jakarta_full, "TOTAL POSITIF")

deaths_map <-simple_map_plot(jakarta_full, "TOTAL MENINGGAL")
```

### Visualise each of the maps side by side
```{r echo=TRUE}
tmap_mode("plot")

tmap_arrange(pop_map, positive_map, deaths_map, ncol=3)
```

### Plot Positif Rate for all the months
```{r echo=TRUE}
all_meninggal_cols <- c("MENINGGAL_Maret 2020", "MENINGGAL_April 2020", "MENINGGAL_MEI 2020", "MENINGGAL_Juni 2020", "MENINGGAL_Juli 2020", 
                        "MENINGGAL_Agustus 2020", "MENINGGAL_September 2020", "MENINGGAL_Oktober 2020", "MENINGGAL_November 2020", "POSITIF_Desember 2020", 
                        "MENINGGAL_Januari 2021", "MENINGGAL_Februari 2021", "MENINGGAL_Maret 2021", "MENINGGAL_April 2021", "MENINGGAL_Mei 2021", 
                        "MENINGGAL_Juni 2021", "MENINGGAL_Juli 2021")


tmap_arrange(simple_map_plot(jakarta_full_rates_a, "POSITIF_Maret 2020"), simple_map_plot(jakarta_full_rates_a, "POSITIF_April 2020"),
             simple_map_plot(jakarta_full_rates_a, "POSITIF_MEI 2020"), simple_map_plot(jakarta_full_rates_a, "POSITIF_Juni 2020"), 
             simple_map_plot(jakarta_full_rates_a, "POSITIF_Juli 2020"), simple_map_plot(jakarta_full_rates_a, "POSITIF_Agustus 2020"),
             simple_map_plot(jakarta_full_rates_a, "POSITIF_September 2020"), simple_map_plot(jakarta_full_rates_a, "POSITIF_Oktober 2020"), 
             simple_map_plot(jakarta_full_rates_a, "POSITIF_November 2020"), simple_map_plot(jakarta_full_rates_a, "POSITIF_Desember 2020"), 
             simple_map_plot(jakarta_full_rates_a, "POSITIF_Januari 2021"), simple_map_plot(jakarta_full_rates_a, "POSITIF_Februari 2021"), 
             simple_map_plot(jakarta_full_rates_a, "POSITIF_Maret 2021"), simple_map_plot(jakarta_full_rates_a, "POSITIF_April 2021"), 
             simple_map_plot(jakarta_full_rates_a, "POSITIF_Mei 2021"), simple_map_plot(jakarta_full_rates_a, "POSITIF_Juni 2021"), 
             simple_map_plot(jakarta_full_rates_a, "POSITIF_Juli 2021"), outer.margins=0)
    
             
```

### Plot Meninggal Rate for all the months
```{r echo=TRUE}
tmap_arrange(simple_map_plot(jakarta_full_rates, "MENINGGAL_Maret 2020"), simple_map_plot(jakarta_full_rates, "MENINGGAL_April 2020"),
             simple_map_plot(jakarta_full_rates, "MENINGGAL_MEI 2020"), simple_map_plot(jakarta_full_rates, "MENINGGAL_Juni 2020"), 
             simple_map_plot(jakarta_full_rates, "MENINGGAL_Juli 2020"), simple_map_plot(jakarta_full_rates, "MENINGGAL_Agustus 2020"),
             simple_map_plot(jakarta_full_rates, "MENINGGAL_September 2020"), simple_map_plot(jakarta_full_rates, "MENINGGAL_Oktober 2020"), 
             simple_map_plot(jakarta_full_rates, "MENINGGAL_November 2020"), simple_map_plot(jakarta_full_rates, "MENINGGAL_Desember 2020"), 
             simple_map_plot(jakarta_full_rates, "MENINGGAL_Januari 2021"), simple_map_plot(jakarta_full_rates, "MENINGGAL_Februari 2021"), 
             simple_map_plot(jakarta_full_rates, "MENINGGAL_Maret 2021"), simple_map_plot(jakarta_full_rates, "MENINGGAL_April 2021"), 
             simple_map_plot(jakarta_full_rates, "MENINGGAL_Mei 2021"), simple_map_plot(jakarta_full_rates, "MENINGGAL_Juni 2021"), 
             simple_map_plot(jakarta_full_rates, "MENINGGAL_Juli 2021"), outer.margins=0)


```



### Plot Positif Rates for the different quarters
```{r echo=TRUE}
first_quarter_pos <- simple_map_plot(jakarta_full_rates_qtr, "First Quarter Positif")

second_quarter_pos <- simple_map_plot(jakarta_full_rates_qtr, "Second Quarter Positif")

third_quarter_pos <- simple_map_plot(jakarta_full_rates_qtr, "Third Quarter Positif")

fourth_quarter_pos <- simple_map_plot(jakarta_full_rates_qtr, "Fourth Quarter Positif")

tmap_arrange(first_quarter_pos, second_quarter_pos, third_quarter_pos, fourth_quarter_pos)
```

### Plot Meninggal Rates for the different quarters
```{r echo=TRUE}
first_quarter_meng <- simple_map_plot(jakarta_full_rates_qtr, "First Quarter Meninggal")

second_quarter_meng <- simple_map_plot(jakarta_full_rates_qtr, "Second Quarter Meninggal")

third_quarter_meng <- simple_map_plot(jakarta_full_rates_qtr, "Third Quarter Meninggal")

fourth_quarter_meng <- simple_map_plot(jakarta_full_rates_qtr, "Fourth Quarter Meninggal")

tmap_arrange(first_quarter_meng, second_quarter_meng, third_quarter_meng, fourth_quarter_meng)
```

## Percentile Maps
### Creating helper functions

### Create a function to extract a variable as a vector from a sf dataframe
```{r}
get.var <- function(vname,df) {
  v <- df[vname] %>% 
    st_set_geometry(NULL)
  v <- unname(v[[1]])
  return(v)
}
```

### Create a function to perform Percentile Mapping
```{r}
percentmap <- function(vnam, df, legtitle=NA, mtitle="Percentile Map"){
  percent <- c(0,.01,.1,.5,.9,.99,1)
  var <- get.var(vnam,df)
  bperc <- quantile(var,percent)
  tm_shape(jakarta_full_rates) +
  tm_polygons() +
  tm_shape(df) +
     tm_fill(vnam,
             title=legtitle,
             breaks=bperc,
             palette="Blues",
          labels=c("< 1%", "1% - 10%", "10% - 50%", "50% - 90%", "90% - 99%", "> 99%"))  +
  tm_borders() +
  tm_layout(title = mtitle, title.position = c("right","bottom"))
}
```

```{r}
percentmap("MENINGGAL_April 2021", jakarta_full_rates)
```
### Creating the boxbreaks function
```{r echo=TRUE}
boxbreaks <- function(v,mult=1.5) {
  qv <- unname(quantile(v))
  iqr <- qv[4] - qv[2]
  upfence <- qv[4] + mult * iqr
  lofence <- qv[2] - mult * iqr
  # initialize break points vector
  bb <- vector(mode="numeric",length=7)
  # logic for lower and upper fences
  if (lofence < qv[1]) {  # no lower outliers
    bb[1] <- lofence
    bb[2] <- floor(qv[1])
  } else {
    bb[2] <- lofence
    bb[1] <- qv[1]
  }
  if (upfence > qv[5]) { # no upper outliers
    bb[7] <- upfence
    bb[6] <- ceiling(qv[5])
  } else {
    bb[6] <- upfence
    bb[7] <- qv[5]
  }
  bb[3:5] <- qv[2:4]
  return(bb)
}

```

### Creating the boxmap function
```{r echo=TRUE}
boxmap <- function(vnam, df, 
                   legtitle=NA,
                   mtitle="Box Map",
                   mult=1.5){
  var <- get.var(vnam,df)
  bb <- boxbreaks(var)
  tm_shape(df) +
     tm_fill(vnam,title=legtitle,
             breaks=bb,
             palette="Blues",
          labels = c("lower outlier", 
                     "< 25%", 
                     "25% - 50%", 
                     "50% - 75%",
                     "> 75%", 
                     "upper outlier"))  +
  tm_borders() +
  tm_layout(title = mtitle, 
            title.position = c("right",
                               "bottom"))
}


```

```{r}
boxmap("MENINGGAL_Maret 2020", jakarta_full_rates_a)



```














